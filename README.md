
# 看護師シフト最適化プログラム 設計書

---

## 第1章：背景・目的

### 背景

現在、クリニックにおける看護師のシフト作成は**Excelで手作業**により行われている。  
シフト作成時には以下のような複数の条件を考慮する必要がある：

- 各看護師から提出された**休暇希望**
- 看護師ごとの**勤務可能条件（夜勤不可、外来専任 など）**
- **夜勤・早番・残番**といった特殊シフトの割当
- 病院の**定休日や祝日考慮**
- 各日の**必要人員数の確保**

これらの条件が複雑に絡み合うため、毎月のシフト作成には**多くの時間と労力が必要**となっている。

### 目的

この業務負担を軽減し、かつ看護師間の公平性や条件の遵守を自動的に実現するために、  
**Pythonによるプログラム**と**Google OR-Toolsを用いた最適化アルゴリズム**により、  
**シフト作成を自動化するシステム**を構築する。

---

## 第2章：システム構成と全体フロー

### 2.1 システム全体構成概要

```
[看護師の休暇希望 (req_shift_8.csv)]
           ↓
 [Python + Google OR-Tools による最適化]
           ↓
[シフト結果を shift_template.xlsx に書き込み]
```

### 2.2 入出力ファイル仕様

| 種類 | ファイル名 | 内容 |
|------|------------|------|
| 入力 | req_shift_8.csv | 看護師の休暇希望（①〜⑥） |
| 出力 | shift_template.xlsx | シフト表シートに反映 |

### 2.3 処理ステップ

1. CSV読み込み
2. 初期シフト作成（Hard制約）
3. 最終調整（Soft制約）
4. Excel出力

### 2.4 使用技術と環境

| 項目 | 内容 |
|------|------|
| 言語 | Python 3.x |
| 最適化 | Google OR-Tools |
| Excel処理 | pandas + openpyxl |
| 実行環境 | macOS (M1) |
| ディレクトリ | workspace/nurse-scheduling/ |

---

## 第3章：制約条件と最適化ロジック

### ✅ Hard制約

- H1: 1日1シフトのみ割当
- H2: 看護師ごとの勤務制限（夜勤・外来等）
- H3: 木・日：休み、土：午後休
- H4: 各曜日に応じた勤務構成（外来・病棟）  
  - 月火水金（8人）：外来5人（CT＝久保）、病棟3人（久保系以外）
  - 月火水金（7人）：外来4人（2・CT＝久保）、病棟3人
  - 木・日：早日・残日に1人ずつ（久保系以外）
  - 土：久保が2/、休み時は他3名で補完
- H5: 毎日夜勤者1名必須
- H6: 夜勤翌日は「×」
- H7: 前月末夜勤者は今月初日に「×」
- H8: 最低休暇日数の確保
- H9: 看護師の希望休①〜⑤を必ず反映

### 🟡 Soft制約

- S1: 休暇日数 ≒ 13日
- S2: 夜勤希望者に月5回夜勤
- S3: 勤務種別を公平に分配
- S4: 夜勤者には「4番」を1回担当

---

## 第4章：モジュール構成と関数設計

### 4.1 ファイル構成

```
nurse-scheduling/
├── main.py
├── initial_assignment.py
├── refine_schedule.py
├── utils/
│   ├── reader.py
│   ├── writer.py
│   ├── validator.py
│   └── constants.py
├── data/
│   ├── req_shift_8.csv
│   └── shift_template.xlsx
└── shift_output.xlsx
```

### 4.2 主な関数

- `main.py`: メイン制御
- `initial_assignment.py`: Hard制約モデルと初期解
- `refine_schedule.py`: Soft制約による改善
- `reader.py`: CSV → DataFrame
- `writer.py`: Excel出力
- `validator.py`: 制約チェックとログ
- `constants.py`: 定数・設定

---

## 第5章：処理の流れと実行フロー

```
1. CSV読み込み（reader.py）
2. 初期割当（initial_assignment.py）
3. 最適化調整（refine_schedule.py）
4. Excel出力（writer.py）
5. 制約チェック（validator.py）
```

- 実行方法：`python main.py`

---

## 第6章：テスト設計

### 単体テスト

- reader: ①〜⑥のパース確認
- initial_assignment: 夜勤制限が守られているか
- refine_schedule: Soft制約が反映されているか
- writer: Excel出力が正しいか

### 結合テスト例

- 正常系：CSV → Excelへの流れが成立
- 異常系：定休日に勤務が入っていないか？

---

## 第7章：まとめ・今後の展望

### 特徴

- 休暇希望と病院ルールを反映
- OR-Toolsによる最適化
- Excelテンプレート連携で導入容易

### 今後の改善

- シフト可視化
- 違反ルールの色分け表示
- Webフォーム入力
- CIテスト導入
- Windowsに対応
- VBAからプログラム実行
- 定休日数など各情報をExcelから取得

### 引き継ぎの注意点

- constants.py と Excel構造が変わったらコード修正必須
